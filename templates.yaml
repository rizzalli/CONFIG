#templates.yaml
#moved from main configuration.yaml

#Humidity and temp sensor from sensibo
  - sensor:
      - name: "Living Room Humidity"
        unique_id: living_room_air_conditioner_humidity1
        device_class: humidity
        unit_of_measurement: "%"
        state: "{{ state_attr('climate.living_room_air_conditioner', 'current_humidity') }}"
  - sensor:    
      - name: "Living Room Temp"
        device_class: temperature
        unique_id: living_room_air_conditioner_temp1
        unit_of_measurement: "°C"
        state: "{{ state_attr('climate.living_room_air_conditioner', 'current_temperature') }}"
  - sensor:
      - name: "Living Room Humidity2"
        device_class: humidity
        unique_id: living_room_air_conditioner_humidity2
        unit_of_measurement: "%"
        state: "{{ state_attr('climate.living_room_air_conditioner', 'current_humidity') }}"
  - sensor:    
      - name: "Living Room Temp2"
        device_class: temperature
        unique_id: living_room_air_conditioner_temp2
        unit_of_measurement: "°C"
        state: "{{ state_attr('climate.living_room_air_conditioner', 'current_temperature') }}"

  # Air purifier attribute sensors (with fallback for entity_id typo)
  - sensor:
      - name: "Air Quality"
        unique_id: vesync_air_quality
        state: >-
          {{
            state_attr('fan.living_room_air_purifier', 'air_quality')
            if state_attr('fan.living_room_air_purifier', 'air_quality') is not none
            else state_attr('fan.living_room_air_purifer', 'air_quality')
          }}

  # Daily health summary helpers
  - sensor:
      - name: "Unavailable Entities"
        unique_id: vesync_unavailable_entities_count
        icon: mdi:alert-circle
        unit_of_measurement: "entities"
        state: >-
          {{ states | selectattr('state', 'in', ['unavailable', 'unknown']) | list | count }}

      - name: "Automations Off"
        unique_id: vesync_automations_off_count
        icon: mdi:robot-off
        unit_of_measurement: "automations"
        state: >-
          {{ states.automation | selectattr('state', 'eq', 'off') | list | count }}

      - name: "Filter Life"
        unique_id: vesync_filter_life
        unit_of_measurement: "%"
        state: >-
          {{
            state_attr('fan.living_room_air_purifier', 'filter_life')
            if state_attr('fan.living_room_air_purifier', 'filter_life') is not none
            else state_attr('fan.living_room_air_purifer', 'filter_life')
          }}

      - name: "Mode"
        unique_id: vesync_mode
        state: >-
          {{
            state_attr('fan.living_room_air_purifier', 'mode')
            if state_attr('fan.living_room_air_purifier', 'mode') is not none
            else state_attr('fan.living_room_air_purifer', 'mode')
          }}

      - name: "Screen Status"
        unique_id: vesync_screen_status
        state: >-
          {{
            state_attr('fan.living_room_air_purifier', 'screen_status')
            if state_attr('fan.living_room_air_purifier', 'screen_status') is not none
            else state_attr('fan.living_room_air_purifer', 'screen_status')
          }}

  # Proxy fan to avoid preset-mode errors when adjusting percentage
  # This exposes a percentage-only fan that wraps the real purifier.
  # Use this entity in dashboards to adjust speed without triggering
  # invalid preset_mode messages from the UI.
  - fan:
      - name: "Living Room Air Purifier (Proxy)"
        unique_id: living_room_air_purifier_proxy
        availability_template: >-
          {{
            states('fan.living_room_air_purifier') not in ['unavailable', 'unknown']
            or states('fan.living_room_air_purifer') not in ['unavailable', 'unknown']
          }}
        # Mirror the on/off state of the underlying fan
        state: >-
          {{
            states('fan.living_room_air_purifier')
            if states('fan.living_room_air_purifier') != 'unavailable'
            else states('fan.living_room_air_purifer')
          }}
        # Expose only percentage control; do NOT expose preset_modes here
        percentage_template: >-
          {{
            (state_attr('fan.living_room_air_purifier', 'percentage')
             if state_attr('fan.living_room_air_purifier', 'percentage') is not none
             else state_attr('fan.living_room_air_purifer', 'percentage')) or 0
          }}
        turn_on:
          service: fan.turn_on
          data:
            entity_id: >-
              {{ 'fan.living_room_air_purifier'
                 if states('fan.living_room_air_purifier') != 'unavailable'
                 else 'fan.living_room_air_purifer' }}
        turn_off:
          service: fan.turn_off
          data:
            entity_id: >-
              {{ 'fan.living_room_air_purifier'
                 if states('fan.living_room_air_purifier') != 'unavailable'
                 else 'fan.living_room_air_purifer' }}
        set_percentage:
          service: fan.set_percentage
          data:
            entity_id: >-
              {{ 'fan.living_room_air_purifier'
                 if states('fan.living_room_air_purifier') != 'unavailable'
                 else 'fan.living_room_air_purifer' }}
            percentage: "{{ percentage }}"
