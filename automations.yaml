- id: '1762409450745'
  alias: Derryn Leaves
  description: ''
  triggers:
  - trigger: zone
    entity_id: person.derryn_rizzalli
    zone: zone.home
    event: leave
  conditions: []
  actions:
  - parallel:
    - sequence:
      - action: fan.set_percentage
        metadata: {}
        data:
          percentage: 100
        target:
          device_id: c6c759a3bbad55083ec92fe4f1b31966
      - action: timer.start
        metadata: {}
        data:
          duration: 02:00:00
        target:
          entity_id: timer.purifier_auto_timer
      - action: fan.set_preset_mode
        metadata: {}
        data:
          preset_mode: auto
        target:
          device_id: c6c759a3bbad55083ec92fe4f1b31966
    - action: light.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: light.all_lights
    - action: media_player.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: media_player.bravia_k_65xr70
  mode: single
- id: '1762551448042'
  alias: New automation
  description: ''
  triggers:
  - trigger: zone
    entity_id: person.derryn_rizzalli
    zone: zone.home
    event: enter
  conditions:
  - condition: state
    entity_id: timer.purifier_auto_timer
    state:
    - active
  actions:
  - parallel:
    - action: fan.set_preset_mode
      metadata: {}
      data:
        preset_mode: auto
      target:
        device_id: c6c759a3bbad55083ec92fe4f1b31966
    - action: timer.cancel
      metadata: {}
      data: {}
      target:
        entity_id: timer.purifier_auto_timer
  mode: single
- id: '1762566029082'
  alias: Light Sequence
  description: ''
  triggers:
  - trigger: event
    event_type: Button Press
    context:
      user_id:
      - a9a4bcd0abdc4eea9d12c114afac749d
  conditions: []
  actions:
  - action: light.turn_on
    metadata: {}
    data:
      brightness_pct: 100
    target:
      entity_id: light.floor_lamp
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 900
  - action: light.turn_on
    metadata: {}
    data:
      brightness_pct: 100
    target:
      entity_id: light.desk_lamp
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 900
  - action: light.turn_on
    metadata: {}
    data:
      brightness_pct: 100
    target:
      entity_id: light.kitchen_bench
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 900
  - action: light.turn_on
    metadata: {}
    data:
      brightness_pct: 100
    target:
      entity_id: light.kitchen_strip
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 900
  - action: light.turn_on
    metadata: {}
    data:
      brightness_pct: 100
    target:
      entity_id: light.tv_light
  - delay:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 900
  - action: light.turn_on
    metadata: {}
    data:
      brightness_pct: 100
    target:
      entity_id: light.bedroom
  mode: single

# git push automations
- id: gitpushauto-start
  alias: "Git auto-sync on HA start"
  mode: single
  trigger:
    - platform: homeassistant
      event: start
  actions:
    - service: shell_command.git_sync

- id: gitpushauto-nightly
  alias: "Git auto-sync nightly 02:00"
  mode: single
  trigger:
    - platform: time
      at: "02:00:00"
  actions:
    - service: shell_command.git_sync

# Debug: capture purifier preset mode transitions
- id: air_purifier_preset_debug
  alias: "Debug: Purifier preset mode requests"
  description: "Logs requests to change preset mode for the living room air purifier with prior state context."
  mode: queued
  max: 10
  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: fan
        service: set_preset_mode
  condition:
    - condition: template
      value_template: >-
        {{ (trigger.event.data.service_data.entity_id == 'fan.living_room_air_purifier') or
           (trigger.event.data.service_data.entity_id == 'fan.living_room_air_purifer') }}
  actions:
    - variables:
        requested: "{{ trigger.event.data.service_data.preset_mode }}"
        prev_pct: >-
          {{ state_attr('fan.living_room_air_purifier','percentage')
             if state_attr('fan.living_room_air_purifier','percentage') is not none
             else state_attr('fan.living_room_air_purifer','percentage') }}
        prev_preset: >-
          {{ state_attr('fan.living_room_air_purifier','preset_mode')
             if state_attr('fan.living_room_air_purifier','preset_mode') is not none
             else state_attr('fan.living_room_air_purifer','preset_mode') }}
    - service: persistent_notification.create
      data:
        title: "Purifier preset request"
        message: >-
          Requested preset: {{ requested }}\nPrevious preset: {{ prev_preset or 'none' }}\nPrevious percentage: {{ prev_pct if prev_pct is not none else 'none' }}

# Mitigation: smooth manual -> preset transition to reduce invalid preset warnings
- id: air_purifier_preset_fix
  alias: "Fix: Purifier manual to preset transition"
  description: "Ensures percentage is cleared before applying preset mode to avoid backend warning."
  mode: single
  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: fan
        service: set_preset_mode
  condition:
    - condition: template
      value_template: >-
        {{ (trigger.event.data.service_data.entity_id in ['fan.living_room_air_purifier','fan.living_room_air_purifer']) and
           (state_attr('fan.living_room_air_purifier','percentage') not in [None, 0] or
            state_attr('fan.living_room_air_purifer','percentage') not in [None, 0]) }}
  actions:
    - variables:
        target_entity: >-
          {{ 'fan.living_room_air_purifier' if states('fan.living_room_air_purifier') != 'unavailable' else 'fan.living_room_air_purifer' }}
        requested_preset: "{{ trigger.event.data.service_data.preset_mode }}"
    # Step 1: briefly set percentage to 0 (some integrations treat this as clearing manual speed)
    - service: fan.set_percentage
      data:
        entity_id: "{{ target_entity }}"
        percentage: 0
    - delay: '00:00:01'
    # Step 2: apply requested preset again
    - service: fan.set_preset_mode
      data:
        entity_id: "{{ target_entity }}"
        preset_mode: "{{ requested_preset }}"
    # Optional: notify for traceability (can be removed later)
    - service: persistent_notification.create
      data:
        title: "Purifier preset fix applied"
        message: >-
          Re-applied preset '{{ requested_preset }}' after clearing manual percentage.
